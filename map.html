<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Карта АЗС Роснефть — WebApp</title>

<!-- Яндекс.Карты -->
<script src="https://api-maps.yandex.ru/2.1/?apikey=f0b35562-f43f-4407-9729-14d98daca723&lang=ru_RU"></script>
<!-- Telegram WebApp (для встроенного открытия в Telegram) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif}
  #sidebar{position:fixed;left:0;top:0;bottom:0;width:340px;border-right:1px solid #ddd;background:#fff;overflow:auto;padding:10px;box-sizing:border-box;z-index:10}
  #map{position:fixed;left:340px;right:0;top:0;bottom:0}
  .station{padding:8px;border-bottom:1px solid #eee;cursor:pointer}
  .station:hover{background:#f6f6f6}
  .station .title{font-weight:700}
  .controls{margin-bottom:8px}
  .small{font-size:12px;color:#666}
  .btn{display:inline-block;padding:6px 10px;margin:4px 4px 4px 0;border:1px solid #ccc;background:#fafafa;cursor:pointer;border-radius:4px}
  .btn-primary{background:#1673ff;color:#fff;border-color:#0f5bcc}
  #count{margin-top:6px;font-size:13px;color:#333}
  .fuel-list{margin:6px 0;padding-left:16px}
  .service-tag{display:inline-block;background:#eef; color:#115; padding:3px 6px;border-radius:4px;margin-right:4px;font-size:12px}
</style>
</head>
<body>

<div id="sidebar">
  <div class="controls">
    <input id="q" placeholder="Поиск: адрес, регион, бренд..." style="width:100%;box-sizing:border-box;padding:8px;margin-bottom:8px" />
    <div>
      <button id="nearBtn" class="btn">Показать ближайшие</button>
      <button id="loadBtn" class="btn">Загрузить первые (макс 100)</button>
      <button id="clearBtn" class="btn">Очистить метки</button>
    </div>
    <div id="count" class="small"></div>
  </div>

  <div id="list"></div>
</div>

<div id="map"></div>

<script>
/*
  map.html
  - Зависит от файла stations.json (в той же папке). Этот JSON создаётся из rncard.xlsx.
  - Поведение: список в сайдбаре, клик — геокодируется адрес и ставится метка с детальной карточкой.
  - Поддерживается кластеризация, поиск и ближайшие станции.
*/

const tg = window.Telegram?.WebApp;
if (tg) { try { tg.expand(); tg.MainButton.hide(); } catch(e){} }

let map, clusterer;
let stations = [];
let geocodeCache = {}; // key: address -> [lat, lon]
let shownPlacemarks = [];

function setCount(text){ document.getElementById('count').innerText = text; }

// загрузим stations.json (файл должен быть рядом с map.html)
fetch('stations.json')
  .then(r => r.json())
  .then(data => {
    stations = data;
    setCount('Всего станций: ' + stations.length);
    renderList(stations.slice(0,500)); // initial (limit to avoid huge DOM)
  })
  .catch(e => {
    console.error('Ошибка загрузки stations.json', e);
    setCount('Ошибка загрузки данных.');
  });

ymaps.ready(init);

function init() {
  map = new ymaps.Map('map', {
    center: [55.76, 37.64],
    zoom: 5,
    controls: ['zoomControl','searchControl','geolocationControl']
  });

  clusterer = new ymaps.Clusterer({
    preset: 'islands#invertedVioletClusterIcons',
    groupByCoordinates: false,
    clusterDisableClickZoom: false
  });
  map.geoObjects.add(clusterer);
}

// отрисовать список (click -> showStation)
function renderList(list) {
  const el = document.getElementById('list');
  el.innerHTML = '';
  if(!list || !list.length){ el.innerHTML = '<div class="small">Список пуст</div>'; return; }
  list.forEach((s, idx) => {
    const d = document.createElement('div'); d.className='station'; d.dataset.idx = idx;
    const brand = s.brand || 'АЗС';
    d.innerHTML = '<div class="title">'+escapeHtml(brand)+'</div>'
                + '<div class="small">'+escapeHtml(s.address||'')+'</div>'
                + '<div class="small">'+escapeHtml(s.region||'')+'</div>';
    d.addEventListener('click', ()=> showStationByObject(s));
    el.appendChild(d);
  });
}

// экранирование
function escapeHtml(t){ if(!t) return ''; return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// показать станцию: геокодируем адрес (если нужно) и добавляем метку
function showStationByObject(s){
  if(!s.address || s.address.trim()===''){ alert('У этой станции нет адреса'); return; }
  const key = s.address;
  if(geocodeCache[key]){
    const coords = geocodeCache[key];
    addPlacemark(coords, s);
    map.setCenter(coords, 14);
    return;
  }
  ymaps.geocode(s.address, { results: 1 }).then(res => {
    if(res.geoObjects.getLength()){
      const g = res.geoObjects.get(0);
      const coords = g.geometry.getCoordinates();
      geocodeCache[key] = coords;
      addPlacemark(coords, s);
      map.setCenter(coords, 14);
    } else {
      alert('Не удалось найти координаты для адреса: ' + s.address);
    }
  }, err => {
    console.error('geocode err', err);
    alert('Ошибка геокодирования');
  });
}

// собрать HTML карточки с ценами и сервисами
function buildBalloonHtml(s){
  let html = '<div style="min-width:220px">';
  html += '<b>' + escapeHtml(s.brand||'АЗС') + '</b><br/>';
  if(s.address) html += '<div class="small">' + escapeHtml(s.address) + '</div>';
  if(s.region) html += '<div class="small">Регион: ' + escapeHtml(s.region) + '</div>';
  html += '<hr/>';
  html += '<b>Топливо:</b><ul class="fuel-list">';
  const fuels = s.fuels || {};
  for(const k in fuels){
    const v = fuels[k];
    if(v && String(v).trim()!==''){
      html += '<li>' + escapeHtml(k) + (v ? ': ' + escapeHtml(v) : '') + '</li>';
    }
  }
  html += '</ul>';
  html += '<b>Сервисы:</b><div>';
  const sv = s.services || {};
  for(const k in sv){
    const v = sv[k];
    if(v && String(v).trim()!==''){
      html += '<span class="service-tag">' + escapeHtml(k) + (v ? ': ' + escapeHtml(v) : '') + '</span>';
    }
  }
  html += '</div>';
  if(s.nds) html += '<div class="small">НДС: ' + escapeHtml(s.nds) + '</div>';
  html += '</div>';
  return html;
}

// добавить метку и открыть балун
function addPlacemark(coords, s){
  const balloon = buildBalloonHtml(s);
  const placemark = new ymaps.Placemark(coords, {
    balloonContentBody: balloon,
    hintContent: s.brand || 'АЗС'
  }, {
    preset: 'islands#orangeFuelStationIcon'
  });
  clusterer.add(placemark);
  shownPlacemarks.push(placemark);
  placemark.balloon.open();
}

// очистить показанные метки (кластеры)
function clearPlacemarks(){
  clusterer.removeAll();
  shownPlacemarks = [];
  geocodeCache = {}; // можно не очищать, но если хочешь свежесть - очищаем
}

// поиск по вводу
document.getElementById('q').addEventListener('input', function(){
  const q = this.value.trim().toLowerCase();
  if(!q){ renderList(stations.slice(0,500)); setCount('Всего: ' + stations.length); return; }
  const res = stations.filter(s => (String(s.address||'') + ' ' + String(s.region||'') + ' ' + String(s.brand||'')).toLowerCase().includes(q));
  renderList(res.slice(0,500));
  setCount('Найдено: ' + res.length);
});

// кнопка "Загрузить первые" — по списку сайдбара геокодирует и ставит метки до 100 штук
document.getElementById('loadBtn').addEventListener('click', function(){
  const items = Array.from(document.querySelectorAll('.station')).slice(0,100);
  if(!items.length){ alert('Нечего загружать'); return; }
  let i=0;
  function next(){
    if(i>=items.length) return;
    const idx = items[i].dataset.idx;
    const s = stations[idx];
    if(s) showStationByObject(s);
    i++;
    setTimeout(next, 200);
  }
  next();
});

// кнопка "Показать ближайшие" — берём геопозицию браузера и вычисляем ближайшие станции
document.getElementById('nearBtn').addEventListener('click', function(){
  if(!navigator.geolocation){ alert('Геолокация не поддерживается'); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const user = [pos.coords.latitude, pos.coords.longitude];
    // Чтобы сравнивать дистанцию без геокодирования всех, геокодируем потихоньку первые 500 записей
    const sample = stations.slice(0,500);
    let i=0; const results=[];
    function procNext(){
      if(i>=sample.length){
        results.sort((a,b)=>a.d-b.d);
        const top = results.slice(0,50).map(r=>r.s);
        renderList(top);
        top.slice(0,10).forEach(r=>addPlacemark(r.coords, r.s));
        map.setCenter(user, 10);
        return;
      }
      const s = sample[i++];
      const key = s.address;
      function handleCoords(coords){
        const dx = coords[0]-user[0], dy = coords[1]-user[1];
        const d = Math.sqrt(dx*dx + dy*dy);
        results.push({s:s, coords:coords, d:d});
        setTimeout(procNext, 120);
      }
      if(geocodeCache[key]) handleCoords(geocodeCache[key]);
      else{
        ymaps.geocode(s.address, { results:1 }).then(res=>{
          if(res.geoObjects.getLength()){
            const coords = res.geoObjects.get(0).geometry.getCoordinates();
            geocodeCache[key]=coords;
            handleCoords(coords);
          } else {
            setTimeout(procNext, 0);
          }
        }, err => { console.error(err); setTimeout(procNext, 0); });
      }
    }
    procNext();
  }, err => { alert('Не удалось получить местоположение'); }, {timeout:10000});
});

// кнопка очистки
document.getElementById('clearBtn').addEventListener('click', function(){ clearPlacemarks(); });

// утилита: показать первые N в списке из stations.json при первой загрузке
function renderInitial(){
  renderList(stations.slice(0,500));
}

// helper
function setCount(text){ document.getElementById('count').innerText = text; }

</script>
</body>
</html>
